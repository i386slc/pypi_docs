# Вопросы-ответы gunicorn

## Биты WSGI

### Как установить SCRIPT\_NAME?

По умолчанию **SCRIPT\_NAME** — это пустая строка. Значение можно установить, установив **SCRIPT\_NAME** в среде или в качестве заголовка **HTTP**.

## Серверный штат

### Как перезагрузить приложение в Gunicorn?

Вы можете изящно перезагрузить, отправив сигнал **HUP** для gunicorn:

```bash
$ kill -HUP masterpid
```

### Как я могу протестировать конфигурацию прокси?

Программа [Hey](https://github.com/rakyll/hey) — отличный способ проверить, правильно ли ваш прокси-сервер буферизует ответы для синхронных рабочих процессов:

```bash
$ hey -n 10000 -c 100 http://127.0.0.1:5000/
```

Это запускает тест из 10000 запросов, из которых 100 выполняются одновременно.

### Как я могу назвать процессы?

Если вы установите пакет Python [setproctitle](https://pypi.python.org/pypi/setproctitle), **Gunicorn** установит имена процессов на что-то более осмысленное. Это повлияет на вывод, который вы видите в таких инструментах, как **ps** и **top**. Это помогает различать главный процесс, а также главные процессы при запуске более одного приложения на одном компьютере. См. параметр [proc\_name](nastroika-gunicorn.md#proc\_name) для получения дополнительной информации.

### Почему нет HTTP Keep-Alive?

По умолчанию синхронные воркеры предназначены для работы за **Nginx**, который использует только **HTTP/1.0** со своими вышестоящими серверами. Если вы хотите развернуть **Gunicorn** для обработки небуферизованных запросов (т. е. обслуживания запросов непосредственно из Интернета), вам следует использовать один из асинхронных рабочих процессов.

## Процессы воркера

### Как узнать, какой тип воркера использовать?

Прочтите страницу [Дизайн gunicorn](dizain-gunicorn.md), чтобы получить справку о различных типах воркеров.

### Какие типы воркеров существуют?

Ознакомьтесь с документацией по конфигурации для [worker\_class](nastroika-gunicorn.md#worker\_class).

### Как определить наилучшее количество рабочих процессов?

Вот наша рекомендация по настройке [количества воркеров](dizain-gunicorn.md#skolko-vorkerov).

### Как я могу динамически изменять количество воркеров?

Сигналы **TTIN** и **TTOU** могут быть отправлены мастеру для увеличения или уменьшения количества воркеров.

Чтобы увеличить количество воркеров на единицу:

```bash
$ kill -TTIN $masterpid
```

Чтобы уменьшить количество воркеров на единицу:

```bash
$ kill -TTOU $masterpid
```

### Страдает ли Gunicorn от проблемы громоподобного стада?

Проблема громоподобного стада возникает, когда множество спящих обработчиков запросов, которые могут быть потоками или процессами, просыпаются одновременно для обработки нового запроса. Поскольку только один обработчик получит запрос, остальные будут разбужены без всякой причины, что приведет к трате циклов CPU. В настоящее время **Gunicorn** не реализует какое-либо решение **IPC** для координации между рабочими процессами. Вы можете столкнуться с высокой нагрузкой из-за этой проблемы при использовании многих рабочих процессов или потоков. Однако [работа по устранению этой проблемы уже начата](https://github.com/benoitc/gunicorn/issues/792).

### Почему я не вижу никаких логов в консоли?

В версии `19.0` **Gunicorn** по умолчанию не регистрируется в консоли. Для просмотра логов в консоли нужно использовать опцию `--log-file=-`. В версии `19.2` **Gunicorn** снова входит в консоль по умолчанию.

## Параметры ядра

При работе с большим количеством одновременных подключений вам может потребоваться настроить несколько параметров ядра. Как правило, они должны затрагивать только сайты с очень большой одновременной нагрузкой. Эти параметры не являются специфическими для **Gunicorn**, они применимы к любому сетевому серверу, который вы можете использовать.

Эти команды предназначены для **Linux**. Ваша конкретная ОС может иметь немного другие параметры.

### Как увеличить максимальное количество файловых дескрипторов?

Одна из первых настроек, которую обычно необходимо увеличить, — это максимальное количество дескрипторов открытых файлов для данного процесса. Для тех, кто запутался, помните, что **Unices** рассматривает сокеты как файлы.

```bash
$ sudo ulimit -n 2048
```

### Как я могу увеличить максимальное количество резервных сокетов?

Прослушивающие сокеты имеют связанную очередь входящих подключений, ожидающих принятия. Если у вас есть паническое бегство клиентов, которые заполняют эту очередь, новые соединения в конечном итоге начнут сбрасываться.

```bash
$ sudo sysctl -w net.core.somaxconn="2048"
```

### Как я могу отключить использование sendfile()

Отключить использование `sendfile()` можно с помощью параметра `--no-sendfile` или установив для переменной окружения **SENDFILE** значение `0`.

## Исправление проблем

### Как исправить сообщение Django об ошибке ImproperlyConfigured?

С асинхронными рабочими процессами создание URL-адресов с функцией **reverse** `django.core.urlresolvers` может завершиться ошибкой. Вместо этого используйте **reverse\_lazy**.

### Как избежать чрезмерной блокировки Gunicorn в os.fchmod?

Текущая система **Heartbeat** включает вызов **os.fchmod** для обработчиков временных файлов и может заблокировать рабочий процесс на произвольное время, если каталог находится в файловой системе на диске. Например, по умолчанию `/tmp` не монтируется как **tmpfs** в Ubuntu; в **AWS** том корневого инстанса **EBS** иногда может зависнуть на полминуты и за это время воркеры **Gunicorn** могут полностью заблокироваться в **os.fchmod**. **os.fchmod** может привести к дополнительным задержкам, если диск переполнится. Также **Gunicorn** может отказаться запускаться, если не может создать файлы при заполненном диске.

В настоящее время, чтобы избежать этих проблем, вы можете использовать монтирование **tmpfs** (для нового каталога или для `/tmp`) и передать его путь в **--worker-tmp-dir**. Во-первых, проверьте, поддерживается ли ваш `/tmp` диском или оперативной памятью:

```bash
$ df /tmp
Filesystem     1K-blocks    Used Available Use% Mounted on
/dev/xvda1           ...     ...       ...  ... /
```

Неудачно. Если вы используете **Fedora** или **Ubuntu**, у вас уже должно быть монтирование **tmpfs** в `/dev/shm`:

```bash
$ df /dev/shm
Filesystem     1K-blocks     Used Available Use% Mounted on
tmpfs                 ...     ...       ...  ... /dev/shm
```

В этом случае вы можете установить `--worker-tmp-dir /dev/shm`, иначе вы можете создать новое монтирование **tmpfs**:

```bash
sudo cp /etc/fstab /etc/fstab.orig
sudo mkdir /mem
echo 'tmpfs       /mem tmpfs defaults,size=64m,mode=1777,noatime,comment=for-gunicorn 0 0' | sudo tee -a /etc/fstab
sudo mount /mem
```

Проверьте результат:

```bash
$ df /mem
Filesystem     1K-blocks  Used Available Use% Mounted on
tmpfs              65536     0     65536   0% /mem
```

Теперь вы можете установить `--worker-tmp-dir /mem`.

### Почему воркеры тихо убивают?

Иногда тонкая проблема для отладки возникает, когда рабочий процесс убит, а в журнале мало информации о том, что произошло.

Если вы используете обратный прокси-сервер, такой как **NGINX**, вы можете увидеть, что `502` возвращается клиенту.

В логах **gunicorn** вы можете просто увидеть `[35] [INFO] Booting worker с pid: 35`

Вполне нормально, что воркеры убиваются и запускаются, например, из-за настройки **max-requests**. Обычно **gunicorn** захватывает любые сигналы и записывает что-то.

Этот конкретный случай сбоя обычно связан с получением сигнала **SIGKILL**, так как невозможно перехватить этот сигнал. Молчание обычно является распространенным побочным эффектом! Распространенной причиной **SIGKILL** является завершение процесса **OOM** killer из-за нехватки памяти.

Это все чаще встречается в развертываниях контейнеров, где ограничения памяти применяются **cgroups**, вы обычно видите доказательства этого в **dmesg**:

```bash
dmesg | grep gunicorn
Memory cgroup out of memory: Kill process 24534 (gunicorn) score 1506 or sacrifice child
Killed process 24534 (gunicorn) total-vm:1016648kB, anon-rss:550160kB, file-rss:25824kB, shmem-rss:0kB
```

В таких случаях лучше всего настроить ограничение памяти. Также можно настроить **OOM** так, чтобы **SIGKILL** не отправлялся по умолчанию.
