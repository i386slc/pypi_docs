# Настройка gunicorn

Это исчерпывающий список настроек для **Gunicorn**. Некоторые настройки можно установить только из файла конфигурации. Имя параметра — это то, что следует использовать в файле конфигурации. Аргументы командной строки также перечислены для справки по настройке в командной строке.

{% hint style="info" %}
Настройки можно указать с помощью переменной среды **GUNICORN\_CMD\_ARGS**. Можно использовать все доступные аргументы командной строки. Например, чтобы указать адрес привязки и количество воркеров:

```bash
$ GUNICORN_CMD_ARGS="--bind=127.0.0.1 --workers=3" gunicorn app:app
```

_Новое в версии 19.7_.
{% endhint %}

## Файл конфигурации

### config

**Командная строка**: `-c CONFIG` или `--config CONFIG`

**По умолчанию**: `'./gunicorn.conf.py'`

Конфигурационный файл **Gunicorn**.

Строка вида `PATH`, `file:PATH` или `python:MODULE_NAME`.

Имеет эффект только в том случае, если указан в командной строке или как часть конфигурации конкретного приложения.

По умолчанию файл с именем **gunicorn.conf.py** будет считываться из того же каталога, где запускается **gunicorn**.

_Изменено в версии 19.4_: для загрузки конфигурации из модуля Python требуется префикс `python:`.

### wsgi\_app

**По умолчанию**: `None`

Путь к приложению WSGI в шаблоне `$(MODULE_NAME):$(VARIABLE_NAME)`.

_Новое в версии 20.1.0_.

## Отладка

### reload

**Командная строка**: `--reload`

**По умолчанию**: `False`

Перезапуск воркеров при изменении кода.

Эта настройка предназначена для разработки. Это приведет к перезапуску рабочих процессов при каждом изменении кода приложения.

**Reloader** несовместим с предварительной загрузкой приложений. При использовании конфигурации вставки **paste** убедитесь, что блок сервера не импортирует код приложения, иначе перезагрузка не будет работать должным образом.

Поведение по умолчанию — попытка **inotify** с откатом к опросу файловой системы. Как правило, следует предпочесть **inotify**, если он доступен, поскольку он потребляет меньше системных ресурсов.

{% hint style="info" %}
Чтобы использовать загрузчик **inotify**, у вас должен быть установлен пакет **inotify**.
{% endhint %}

### reload\_engine

**Командная строка**: `--reload-engine STRING`

**По умолчанию**: `'auto'`

Реализация, которая должна использоваться для сильной [reload](nastroika-gunicorn.md#reload).

Действительные движки engine:

* `'auto'`
* `'poll'`
* `'inotify'` (требуется **inotify**)

_Новое в версии 19.7_.

### reload\_extra\_files

**Командная строка**: `--reload-extra-file FILES`

**По умолчанию**: `[]`

Расширяет возможность перезагрузки, чтобы также просматривать и [перезагружать](nastroika-gunicorn.md#reload) дополнительные файлы (например, шаблоны, конфигурации, спецификации и т. д.).

_Новое в версии 19.8_.

### spew

**Командная строка**: `--spew`

**По умолчанию**: `False`

Устанавливает функцию трассировки, которая извергает каждую строку, выполняемую сервером.

Это ядерный вариант.

### check\_config

**Командная строка**: `--check-config`

**По умолчанию**: `False`

Проверяет конфигурацию и выходит. Статус выхода равен `0`, если конфигурация правильная, и `1`, если конфигурация неверна.

### print\_config

**Командная строка**: `--print-config`

**По умолчанию**: `False`

Распечатывает параметры конфигурации как полностью разрешенные. Подразумевает [check\_config](nastroika-gunicorn.md#check\_config).

## Логирование

### accesslog

**Командная строка**: `--access-logfile FILES`

**По умолчанию**: `False`

Файл журнала доступа для записи.

`'-'` означает логирование на стандартный вывод.

### disable\_redirect\_access\_to\_syslog

**Командная строка**: `--disable-redirect-access-to-syslog`

**По умолчанию**: `False`

Отключает перенаправление журналов доступа к системному журналу.

_Новое в версии 19.8_.

### access\_log\_format

**Командная строка**: `--access-logformat STRING`

**По умолчанию**: `'%(h)s %(l)s %(u)s %(t)s "%(r)s" %(s)s %(b)s "%(f)s" "%(a)s"'`

Формат журнала доступа.

| Идентификатор | Описание                                    |
| ------------- | ------------------------------------------- |
| h             | удаленный адрес                             |
| l             | `'-'`                                       |
| u             | имя пользователя                            |
| t             | дата запроса                                |
| r             | строка статуса (например, `GET / HTTP/1.1`) |
| m             | метод запроса                               |
| U             | путь URL без строки запроса                 |
| q             | строка запроса                              |
| H             | протокол                                    |
| s             | статус                                      |
| B             | длина ответа                                |
| b             | длина ответа или `'-'` (формат CLF)         |
| f             | реферер                                     |
| a             | агент пользователя                          |
| T             | время запроса в секундах                    |
| M             | время запроса в миллисекундах               |
| D             | время запроса в микросекундах               |
| L             | время запроса в десятичных секундах         |
| p             | ID процесса                                 |
| `{header}i`   | заголовок запроса                           |
| `{header}o`   | заголовок ответа                            |
| `{variable}e` | переменная окружения                        |

Используйте строчные буквы для имен заголовков и переменных среды и поместите имена `{...}x` внутри `%(...)s`. Например:

```python
%({x-forwarded-for}i)s
```

### errorlog

**Командная строка**: `--error-logfile FILE` или `--log-file FILE`

**По умолчанию**: `'-'`

Файл журнала ошибок для записи.

Использование `'-'` для **FILE** приводит к тому, что файл **gunicorn** записывается в **stderr**.

_Изменено в версии 19.2_: логирование в **stderr** по умолчанию.

### loglevel

**Командная строка**: `--log-level LEVEL`

**По умолчанию**: `'info'`

Степень детализации выходных данных журнала ошибок.

Допустимые названия уровней:

* `'debug'`
* `'info'`
* `'warning'`
* `'error'`
* `'critical'`

### capture\_output

**Командная строка**: `--capture-output`

**По умолчанию**: `False`

Перенаправить **stdout/stderr** в указанный файл в журнале ошибок.

_Новое в версии 19.6_.

### logger\_class

**Командная строка**: `--logger-class STRING`

**По умолчанию**: `'gunicorn.glogging.Logger'`

Регистратор, который вы хотите использовать для регистрации событий в **Gunicorn**.

Класс по умолчанию (`gunicorn.glogging.Logger`) обрабатывает большинство обычных способов ведения журнала. Он обеспечивает регистрацию ошибок и доступа.

Вы можете предоставить свой собственный регистратор, предоставив **Gunicorn** путь Python к классу, который "крякает" как `gunicorn.glogging.Logger`.

### logconfig

**Командная строка**: `--log-config FILE`

**По умолчанию**: `None`

Используемый файл конфигурации журнала. **Gunicorn** использует стандартный формат файла конфигурации модуля ведения журнала Python.

### logconfig\_dict

**По умолчанию**: `{}`

Используемый словарь конфигурации журнала с использованием стандартного формата конфигурации словаря модуля ведения журнала Python. Этот параметр имеет приоритет над параметром [logconfig](nastroika-gunicorn.md#logconfig), который использует старый формат конфигурации файла.

Формат:[ https://docs.python.org/3/library/logging.config.html#logging.config.dictConfig](https://docs.python.org/3/library/logging.config.html#logging.config.dictConfig)

_Новое в версии 19.8_.

### syslog\_addr

**Командная строка**: `--log-syslog-to SYSLOG_ADDR`

**По умолчанию**: `'udp://localhost:514'`

Адрес для отправки сообщений системного журнала.

Адрес представляет собой строку вида:

* `unix://PATH#TYPE` : для сокета домена unix. **TYPE** может быть **stream** для потокового драйвера или **dgram** для драйвера **dgram**. **stream** по умолчанию.
* `udp://HOST:PORT` : для сокетов **UDP**
* `tcp://HOST:PORT` : для сокетов **TCP**

### syslog

**Командная строка**: `--log-syslog`

**По умолчанию**: `False`

Отправляет логи **Gunicorn** в **syslog**.

_Изменено в версии 19.8_: теперь вы можете отключить отправку журналов доступа с помощью параметра [disable\_redirect\_access\_to\_syslog](nastroika-gunicorn.md#disable\_redirect\_access\_to\_syslog).

### syslog\_prefix

**Командная строка**: `--log-syslog-prefix SYSLOG_PREFIX`

**По умолчанию**: `None`

Заставляет **Gunicorn** использовать параметр как имя программы в записях системного журнала.

Все записи будут иметь префикс `gunicorn.<prefix>`. По умолчанию именем программы является имя процесса.

### syslog\_facility

**Командная строка**: `--log-syslog-facility SYSLOG_FACILITY`

**По умолчанию**: `'user'`

Имя средства системного журнала

### enable\_stdio\_inheritance

**Командная строка**: `-R` или `--enable-stdio-inheritance`

**По умолчанию**: `False`

Включить наследование **stdio**.

Включить наследование файловых дескрипторов **stdio** в режиме демона.

{% hint style="info" %}
Чтобы отключить буферизацию **stdout** Python, вы можете установить переменную пользовательской среды **PYTHONUNBUFFERED**.
{% endhint %}

### statsd\_host

**Командная строка**: `--statsd-host STATSD_ADDR`

**По умолчанию**: `None`

`host:port` сервера **statsd** для входа.

_Новое в версии 19.1_.

### dogstatsd\_tags

**Командная строка**: `--dogstatsd-tags DOGSTATSD_TAGS`

**По умолчанию**: `''`

Разделенный запятыми список тегов **datadog statsd (dogstatsd)** для добавления к метрикам **statsd**.

_Новое в версии 20_.

### statsd\_prefix

**Командная строка**: `--statsd-prefix STATSD_PREFIX`

**По умолчанию**: `''`

Префикс для использования при выводе показателей **statsd** (добавляется завершающий `.`, если он не указан).

_Новое в версии 19.2_.

## Именование процессов

### proc\_name

**Командная строка**: `-n STRING` или `--name STRING`

**По умолчанию**: `None`

База для использования с **setproctitle** для именования процессов.

Это влияет на такие вещи, как **ps** и **top**. Если вы собираетесь запускать более одного экземпляра **Gunicorn**, вам, вероятно, потребуется установить имя, чтобы отличать их друг от друга. Для этого необходимо установить модуль **setproctitle**.

Если не задано, будет использоваться параметр **default\_proc\_name**.

### default\_proc\_name

**По умолчанию**: `'gunicorn'`.

Внутренняя настройка, которая настраивается для каждого типа приложения.

## SSL

### keyfile

**Командная строка**: `--keyfile FILE`

**По умолчанию**: `None`

Файл ключа SSL

### certifile

**Командная строка**: `--certfile FILE`

**По умолчанию**: `None`

Файл SSL-сертификата

### ssl\_version

**Командная строка**: `--ssl-version`

**По умолчанию**: `<_SSLMethod.PROTOCOL_TLS: 2>`

Версия SSL для использования.

| --ssl-version | Описание                                                                                                                                              |
| ------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------- |
| SSLv3         | SSLv3 не является безопасным и настоятельно не рекомендуется.                                                                                         |
| SSLv23        | Псевдоним для TLS. Устарело в Python 3.6, используйте TLS.                                                                                            |
| TLS           | Согласуйте максимально возможную версию между клиентом и сервером. Может дать SSL. (Python 3.6+)                                                      |
| TLSv1         | TLS 1.0                                                                                                                                               |
| TLSv1\_1      | TLS 1.1 (Python 3.4+)                                                                                                                                 |
| TLSv1\_2      | TLS 1.2 (Python 3.4+)                                                                                                                                 |
| TLS\_SERVER   | Автоматическое согласование самой высокой версии протокола, такой как TLS, но поддержка только соединений SSLSocket на стороне сервера. (Python 3.6+) |

_Изменено в версии 19.7_: значение по умолчанию изменено с **ssl.PROTOCOL\_TLSv1** на **ssl.PROTOCOL\_SSLv23**.

_Изменено в версии 20.0_: этот параметр теперь принимает строковые имена на основе констант **ssl.PROTOCOL\_**.

### cert\_reqs

**Командная строка**: `--cert-reqs`

**По умолчанию**: `<VerifyMode.CERT_NONE: 0>`

Требуется ли сертификат клиента (см. модуль **stdlib ssl**)

### ca\_certs

**Командная строка**: `--ca-certs FILE`

**По умолчанию**: `None`

Файл сертификатов **CA**

### suppress\_ragged\_eofs

**Командная строка**: `--suppress-ragged-eofs`

**По умолчанию**: `True`

Подавление рваных EOF (см. модуль stdlib ssl)

### do\_handshake\_on\_connect

**Командная строка**: `--do-handshake-on-connect`

**По умолчанию**: `False`

Следует ли выполнять подтверждение SSL при подключении к сокету (см. модуль stdlib ssl)

### ciphers

**Командная строка**: `--ciphers`

**По умолчанию**: `None`

Набор шифров SSL для использования в формате списка шифров OpenSSL.

По умолчанию мы используем список шифров по умолчанию из модуля Python ssl, который содержит шифры, считающиеся надежными на момент выпуска каждого выпуска Python.

В качестве рекомендуемой альтернативы Open Web App Security Project (**OWASP**) предлагает [проверенный набор надежных строк шифрования с рейтингом от A+ до C-](https://www.owasp.org/index.php/TLS\_Cipher\_String\_Cheat\_Sheet). **OWASP** предоставляет подробную информацию о совместимости агента пользователя на каждом уровне безопасности.

Подробнее о формате списка шифров OpenSSL см. в [документации по формату списка шифров OpenSSL](https://www.openssl.org/docs/manmaster/man1/ciphers.html#CIPHER-LIST-FORMAT).

## Безопасность

### limit\_request\_line

**Командная строка**: `--limit-request-line INT`

**По умолчанию**: `4094`

Максимальный размер строки HTTP-запроса в байтах.

Этот параметр используется для ограничения допустимого размера строки HTTP-запроса клиента. Поскольку строка запроса состоит из метода HTTP, URI и версии протокола, эта директива накладывает ограничение на длину URL-адреса запроса, разрешенного для запроса на сервере. Серверу необходимо, чтобы это значение было достаточно большим, чтобы вместить любые имена его ресурсов, включая любую информацию, которая может быть передана в части запроса GET-запроса. Значение представляет собой число от `0` (неограниченно) до `8190`.

Этот параметр можно использовать для предотвращения любой DDOS-атаки.

### limit\_request\_fields

**Командная строка**: `--limit-request-fields INT`

**По умолчанию**: `100`

Ограничьте количество полей заголовков HTTP в запросе.

Этот параметр используется для ограничения количества заголовков в запросе для предотвращения DDOS-атаки. При использовании с **limit\_request\_field\_size** это обеспечивает большую безопасность. По умолчанию это значение равно `100` и не может быть больше `32768`.

### limit\_request\_field\_size

**Командная строка**: `--limit-request-field_size INT`

**По умолчанию**: `8190`

Ограничьте допустимый размер поля заголовка HTTP-запроса.

Значение — положительное число или `0`. Установка его на `0` позволит неограниченные размеры полей заголовка.

{% hint style="warning" %}
Установка для этого параметра очень высокого или неограниченного значения может открыть доступ для DDOS-атак.
{% endhint %}

## Серверные хуки

### on\_starting

**По умолчанию**:

```python
def on_starting(server):
    pass
```

Вызывается непосредственно перед инициализацией основного процесса.

Вызываемый объект должен принимать одну переменную экземпляра для **Arbiter**.

### on\_reload

**По умолчанию**:

```python
def on_reload(server):
    pass
```

Вызывается для перезапуска воркеров во время перезагрузки через **SIGHUP**.

Вызываемый объект должен принимать одну переменную экземпляра для **Arbiter**.

### when\_ready

**По умолчанию**:

```python
def when_ready(server):
    pass
```

Вызывается сразу после запуска сервера.

Вызываемый объект должен принимать одну переменную экземпляра для **Arbiter**.

### pre\_fork

**По умолчанию**:

```python
def pre_fork(server, worker):
    pass
```

Вызывается непосредственно перед разветвлением воркера.

Вызываемый объект должен принимать две переменные экземпляра для **Arbiter** и нового **Worker**.

### post\_fork

**По умолчанию**:

```python
def post_fork(server, worker):
    pass
```

Вызывается непосредственно после ответвления воркера.

Вызываемый объект должен принимать две переменные экземпляра для **Arbiter** и нового **Worker**.

### post\_worker\_init

**По умолчанию**:

```python
def post_worker_init(worker):
    pass
```

Вызывается сразу после того, как процесс воркера инициализирует приложение.

Вызываемый объект должен принимать одну переменную экземпляра для инициализированного **Worker**.

### worker\_int

**По умолчанию**:

```python
def worker_int(worker):
    pass
```

Вызывается сразу после выхода воркера по сигналу **SIGINT** или **SIGQUIT**.

Вызываемый объект должен принимать одну переменную экземпляра для инициализированного **Worker**.

### worker\_abort

**По умолчанию**:

```python
def worker_abort(worker):
    pass
```

Вызывается, когда процесс воркера получает сигнал **SIGABRT**.

Этот вызов обычно происходит по тайм-ауту.

Вызываемый объект должен принимать одну переменную экземпляра для инициализированного **Worker**.

### pre\_exec

**По умолчанию**:

```python
def pre_exec(server):
    pass
```

Вызывается непосредственно перед разветвлением нового главного процесса.

Вызываемый объект должен принимать одну переменную экземпляра для **Arbiter**.

### pre\_request

**По умолчанию**:

```python
def pre_request(worker, req):
    worker.log.debug("%s %s" % (req.method, req.path))
```

Вызывается непосредственно перед обработкой запроса процессом воркера.

Вызываемый объект должен принимать две переменные экземпляра для **Worker** и **Request**.

### post\_request

**По умолчанию**:

```python
def post_request(worker, req, environ, resp):
    pass
```

Вызывается после обработки запроса процессом воркера.

Вызываемый объект должен принимать две переменные экземпляра для **Worker** и **Request**.

### child\_exit

**По умолчанию**:

```python
def child_exit(server, worker):
    pass
```

Вызывается сразу после выхода из процесса воркера в главном процессе.

Вызываемый объект должен принимать две переменные экземпляра для **Arbiter** и только что завершившегося **Worker**.

_Новое в версии 19.7_.

### worker\_exit

**По умолчанию**:

```python
def worker_exit(server, worker):
    pass
```

Вызывается сразу после выхода из процесса воркера в рабочем процессе.

Вызываемый объект должен принимать две переменные экземпляра для **Arbiter** и только что завершившегося **Worker**.

### nworkers\_changed

**По умолчанию**:

```python
def nworkers_changed(server, new_value, old_value):
    pass
```

Вызывается сразу после изменения **num\_workers**.

Вызываемый объект должен принимать переменную экземпляра **Arbiter** и два целых числа **Worker** после и до изменения.

Если количество рабочих устанавливается впервые, то **old\_value** будет `None`.

### on\_exit

**По умолчанию**:

```python
def on_exit(server):
    pass
```

Вызывается непосредственно перед выходом из **Gunicorn**.

Вызываемый объект должен принимать одну переменную экземпляра для **Arbiter**.

## Механика сервера

## Сокет сервера

## Процессы воркера
