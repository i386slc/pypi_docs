# Обработка сигналов gunicorn

Краткое описание сигналов, обрабатываемых **Gunicorn**. Мы также документируем сигналы, используемые внутри **Gunicorn** для связи с процессами воркеров.

## Основной процесс

* **QUIT**, **INT** - Быстрое отключение
* **TERM** - Элегантное отключение. Ожидает, пока воркеры закончат выполнение своих текущих запросов до истечения [graceful\_timeout](nastroika-gunicorn.md#graceful\_timeout).
* **HUP** - Перезагрузите конфигурацию, запустите новые рабочие процессы с новой конфигурацией и корректно завершите работу старых рабочих процессов. Если приложение не загружено предварительно (используя параметр [preload\_app](nastroika-gunicorn.md#preload\_app)), **Gunicorn** также загрузит его новую версию.
* **TTIN** - Увеличить количество процессов на один
* **TTOU** - Уменьшить количество процессов на один
* **USR1** - Повторно открыть файлы журнала
* **USR2** - Обновляет **Gunicorn** на лету. Для уничтожения старого мастер-процесса следует использовать отдельный сигнал **TERM**. Этот сигнал также можно использовать для использования новых версий предварительно загруженных приложений. Дополнительную информацию см. в разделе [Обновление до нового двоичного файла на лету](obrabotka-signalov-gunicorn.md#obnovlenie-do-novogo-binarnogo-faila-na-letu).
* **WINCH** - Изящно завершайте рабочие процессы, когда **Gunicorn** демонизируется.

## Процесс воркера

Отправка сигналов непосредственно рабочим процессам обычно не требуется. Если главный процесс запущен, любой завершившийся рабочий процесс будет автоматически возрожден.

* **QUIT**, **INT** - Быстрое отключение
* **TERM** - Элегантное отключение.
* **USR1** - Повторно открыть файлы журнала

## Перезагрузка конфигурации

Сигнал **HUP** можно использовать для перезагрузки конфигурации **Gunicorn** на лету.

```log
2013-06-29 06:26:55 [20682] [INFO] Handling signal: hup
2013-06-29 06:26:55 [20682] [INFO] Hang up: Master
2013-06-29 06:26:55 [20703] [INFO] Booting worker with pid: 20703
2013-06-29 06:26:55 [20702] [INFO] Booting worker with pid: 20702
2013-06-29 06:26:55 [20688] [INFO] Worker exiting (pid: 20688)
2013-06-29 06:26:55 [20687] [INFO] Worker exiting (pid: 20687)
2013-06-29 06:26:55 [20689] [INFO] Worker exiting (pid: 20689)
2013-06-29 06:26:55 [20704] [INFO] Booting worker with pid: 20704
```

Отправка сигнала **HUP** перезагрузит конфигурацию, запустит новые рабочие процессы с новой конфигурацией и корректно завершит работу старых рабочих процессов. Если приложение не загружено предварительно (используя параметр [preload\_app](nastroika-gunicorn.md#preload\_app)), **Gunicorn** также загрузит его новую версию.

## Обновление до нового бинарного файла на лету

_Изменено в версии 19.6.0_: Формат именования файлов **PID** изменен с `<name>.pid.oldbin` на `<name>.pid.2`.

Если вам необходимо заменить бинарник **Gunicorn** на новый (при переходе на новую версию или добавлении/удалении серверных модулей), вы можете сделать это без простоя службы — никакие входящие запросы не будут потеряны. Предварительно загруженные приложения также будут перезагружены.

Сначала замените старый двоичный файл новым, затем отправьте сигнал **USR2** текущему мастер-процессу. Он запускает новый двоичный файл, файл **PID** которого имеет постфикс `.2` (например, `/var/run/gunicorn.pid.2`), который, в свою очередь, запускает новый главный процесс и новые рабочие процессы:

```log
  PID USER      PR  NI  VIRT  RES  SHR S  %CPU %MEM    TIME+  COMMAND
20844 benoitc   20   0 54808  11m 3352 S   0.0  0.1   0:00.36 gunicorn: master [test:app]
20849 benoitc   20   0 54808 9.9m 1500 S   0.0  0.1   0:00.02 gunicorn: worker [test:app]
20850 benoitc   20   0 54808 9.9m 1500 S   0.0  0.1   0:00.01 gunicorn: worker [test:app]
20851 benoitc   20   0 54808 9.9m 1500 S   0.0  0.1   0:00.01 gunicorn: worker [test:app]
20854 benoitc   20   0 55748  12m 3348 S   0.0  0.2   0:00.35 gunicorn: master [test:app]
20859 benoitc   20   0 55748  11m 1500 S   0.0  0.1   0:00.01 gunicorn: worker [test:app]
20860 benoitc   20   0 55748  11m 1500 S   0.0  0.1   0:00.00 gunicorn: worker [test:app]
20861 benoitc   20   0 55748  11m 1500 S   0.0  0.1   0:00.01 gunicorn: worker [test:app]
```

На данный момент работают два экземпляра **Gunicorn**, которые вместе обрабатывают входящие запросы. Чтобы поэтапно отказаться от старого экземпляра, вы должны отправить сигнал **WINCH** старому главному процессу, и его рабочие процессы начнут корректно завершаться.

На этом этапе вы все еще можете вернуться к старому процессу, поскольку он еще не закрыл свои сокеты для прослушивания, выполнив следующие действия:

* Отправьте сигнал **HUP** старому главному процессу — он запустит рабочие процессы без перезагрузки файла конфигурации.
* Отправьте сигнал **TERM** новому главному процессу, чтобы изящно завершить его рабочие процессы.
* Отправьте сигнал **QUIT** новому главному процессу, чтобы заставить его завершить работу.

Если по какой-то причине новые рабочие процессы не завершаются, отправьте им сигнал **KILL** после завершения работы нового главного процесса, и все вернется к тому, что было до попытки обновления.

Если обновление прошло успешно и вы хотите сохранить новый главный процесс, отправьте сигнал **TERM** старому главному процессу, чтобы оставить работающим только новый сервер:

```log
  PID USER      PR  NI  VIRT  RES  SHR S  %CPU %MEM    TIME+  COMMAND
20854 benoitc   20   0 55748  12m 3348 S   0.0  0.2   0:00.45 gunicorn: master [test:app]
20859 benoitc   20   0 55748  11m 1500 S   0.0  0.1   0:00.02 gunicorn: worker [test:app]
20860 benoitc   20   0 55748  11m 1500 S   0.0  0.1   0:00.02 gunicorn: worker [test:app]
20861 benoitc   20   0 55748  11m 1500 S   0.0  0.1   0:00.01 gunicorn: worker [test:app]
```
