# Запуск supervisor

В этом разделе упоминается **BINDIR** при объяснении того, как запускать команды **supervisord** и **supervisorctl**. Это каталог `"bindir"`, с которым настроена ваша установка Python. Например, для установки Python через `./configure --prefix=/usr/local/py; make; make install`, **BINDIR** будет в `/usr/local/py/bin`. Интерпретаторы Python на разных платформах используют разные **BINDIR**. Посмотрите на вывод `setup.py install`, если вы не можете понять, где находится ваш.

## Добавление программы

Прежде чем **supervisord** сделает для вас что-то полезное, вам нужно будет добавить хотя бы один раздел **program** в его конфигурацию. Раздел **program** определяет программу, которая запускается и управляется при вызове команды **supervisord**. Чтобы добавить программу, вам нужно отредактировать файл `supervisord.conf`.

Одной из самых простых программ для запуска является программа UNIX **cat**. Ниже показан раздел программы, который запустит **cat** при запуске процесса **supervisord**.

```ini
[program:foo]
command=/bin/cat
```

Этот раздел можно вырезать и вставить в файл `supervisord.conf`. Это самая простая возможная конфигурация программы, потому что она только называет команду. В разделах конфигурации программы есть много других параметров конфигурации, которые здесь не показаны. См. <mark style="color:purple;">Настройки раздела \[program:x]</mark> для получения дополнительной информации.

## Запуск supervisord

Чтобы запустить **supervisord**, запустите `$BINDIR/supervisord`. Полученный процесс демонизирует себя и отсоединяется от терминала. По умолчанию журнал операций хранится в `$CWD/supervisor.log`.

Вы можете запустить исполняемый файл **supervisord** на переднем плане, передав флаг **-n** в его командной строке. Это полезно для отладки проблем с запуском.

{% hint style="warning" %}
Когда **supervisord** запускается, он ищет свой файл конфигурации в местах по умолчанию, включая _**текущий рабочий каталог**_. Если вы беспокоитесь о безопасности, вы, вероятно, захотите указать аргумент `«-c»` после команды **supervisord**, указывающей абсолютный путь к файлу конфигурации, чтобы гарантировать, что кто-то обманом не запустит его из каталога, который содержит мошеннический файл `supervisord.conf`. Предупреждение выдается, когда супервизор запускается с правами **root** без этого аргумента **-c**.
{% endhint %}

Чтобы изменить набор программ, контролируемых **supervisord**, отредактируйте файл `supervisord.conf` и уничтожьте `kill -HUP` или иным образом перезапустите процесс **supervisord**. Этот файл содержит несколько примеров определений программ.

Команда **supervisord** принимает несколько параметров командной строки. Каждый из этих параметров командной строки переопределяет любое эквивалентное значение в файле конфигурации.

### Параметры командной строки supervisord

\-c FILE, --configuration=FILE

Путь к файлу конфигурации **supervisord**.

\-n, --nodaemon

Запускает **supervisord** на переднем плане.

\-s, --silent

Нет вывода, направленного на стандартный вывод stdout.

\-h, --help

Показать справку по команде **supervisord**.

\-u USER, --user=USER

Имя пользователя **UNIX** или числовой идентификатор пользователя. Если **supervisord** запускается от имени пользователя **root**, при запуске как можно скорее установите для этого пользователя значение **uid**.

\-m OCTAL, --umask=OCTAL

Восьмеричное число (например, `022`), представляющее [umask](http://supervisord.org/glossary.html#term-umask), который должен использоваться **supervisord** после его запуска.

\-d PATH, --directory=PATH

Когда **supervisord** запускается как демон, переходит в этот каталог перед демонизацией.

\-l FILE, --logfile=FILE

Путь к файлу для использования в качестве журнала активности **supervisord**.

\-y BYTES, --logfile\_maxbytes=BYTES

Максимальный размер файла журнала активности **supervisord** до того, как произойдет ротация. Значение умножается на суффикс, например, «1» — это один байт, «1MB» — это 1 мегабайт, «1GB» — это 1 гигабайт.

\-z NUM, --logfile\_backups=NUM

Количество резервных копий журнала действий **supervisord**, которые необходимо хранить. Каждый файл журнала будет иметь размер **logfile\_maxbytes**.

\-e LEVEL, --loglevel=LEVEL

Уровень ведения журнала, на котором **supervisord** должен записывать в журнал операций. Допустимые уровни: **trace**, **debug**, **info**, **warn**, **error** и **critical**.

\-j FILE, --pidfile=FILE

Имя файла, в который **supervisord** должен записать свой файл **pid**.

\-i STRING, --identifier=STRING

Произвольный строковый идентификатор, предоставляемый различными пользовательскими интерфейсами клиента для этого экземпляра **supervisord**.

\-q PATH, --childlogdir=PATH

Путь к каталогу (он должен уже существовать), в который **supervisord** будет записывать журналы дочерних процессов в режиме **AUTO**.

\-k, --nocleanup

Предотвращает выполнение **supervisord** очистки (удаления старых файлов журнала процесса **AUTO**) при запуске.

\-a NUM, --minfds=NUM

Минимальное количество файловых дескрипторов, которое должно быть доступно для процесса **supervisord**, прежде чем он будет успешно запущен.

\-t, --strip\_ansi

Удалите escape-последовательности **ANSI** из всех дочерних процессов журнала.

\-v, --version

Выводит номер версии **supervisord** на стандартный вывод и выходит.

\--profile\_options=LIST

Разделенный запятыми список опций для профилирования. Заставляет **supervisord** запускаться под профилировщиком и выводить результаты на основе параметров, которые представляют собой список, разделенный запятыми, из следующего: **cumulative**, **calls**, **callers**. Например, **cumulative**, **callers**.

\--minprocs=NUM

Минимальное количество слотов процесса ОС, которое должно быть доступно для процесса **supervisord**, прежде чем он будет успешно запущен.

## Запуск supervisortcl

Чтобы запустить **supervisorctl**, запустите `$BINDIR/supervisorctl`. Будет представлена оболочка, которая позволит вам контролировать процессы, которыми в данный момент управляет **supervisord**. Введите `"help"` в приглашении, чтобы получить информацию о поддерживаемых командах.

Исполняемый файл **supervisorctl** может быть вызван «одноразовыми» командами при вызове с аргументами из командной строки. Пример: `supervisorctl stop all`. Если в командной строке присутствуют аргументы, это предотвратит вызов интерактивной оболочки. Вместо этого команда будет выполнена, и **supervisorctl** завершит работу с кодом `0` в случае успеха или выполнения и ненулевым кодом в случае ошибки. Пример: `supervisorctl status all` будет возвращать ненулевое значение, если какой-либо отдельный процесс не запущен.

Если **supervisorctl** вызывается в интерактивном режиме для **supervisord**, требующего аутентификации, вам будет предложено ввести учетные данные для аутентификации.

### Параметры командной строки supervisorctl

\-c, --configuration

Путь к файлу конфигурации (по умолчанию `/etc/supervisord.conf`)

\-h, --help

Распечатывает сообщение справки и выходит

\-i, --interactive

Запускает интерактивную оболочку после выполнения команд

\-s, --serverurl URL

URL-адрес, который прослушивает сервер **supervisord** (по умолчанию «`http://localhost:9001`»).

\-u, --username

Имя пользователя для аутентификации на сервере

\-p, --password

Пароль для аутентификации на сервере

\-r, --history-file

Сохраняет историю чтения (если доступно чтение)

#### _action \[arguments]_

Действия — это команды типа `"tail"` или `"stop"`. Если указано **-i** или в командной строке не указано действие, запускается `"shell"`, интерпретирующая действия, вводимые в интерактивном режиме. Воспользуйтесь командой `"help"`, чтобы узнать о доступных действиях.

### Действия supervisorctl

`help`

Распечатывает список доступных действий

`help <action>`

Распечатывает справку для `<action>`

`add <name> [...]`

Активирует любые обновления в конфигурации для процесса/группы

`remove <name> [...]`

Удаляет процесс/группу из активной конфигурации

`update`

Перезагружает конфигурацию и добавляет/удаляет по мере необходимости, и перезапускает затронутые программы.

`update all`

Перезагружает конфигурацию и добавляет/удаляет по мере необходимости, и перезапускает затронутые программы.

`update <gname> [...]`

Обновляет определенные группы и перезапускает затронутые программы.

`clear <name>`

Очистить файлы журнала процесса.

`clear <name> <name>`

Очистить файлы журнала нескольких процессов

`clear all`

Очистить все файлы журналов процессов

`fg <process>`

Подключиться к процессу в режиме переднего плана. Нажмите `Ctrl+C`, чтобы выйти из режима переднего плана.

`pid`

Получите PID **supervisord**.

`pid <name>`

Получить PID одного дочернего процесса по имени.

`pid all`

Получите PID каждого дочернего процесса, по одному на строку.

`reload`

Перезапускает удаленный **supervisord**

`reread`

Перезагружает файлы конфигурации демона без добавления/удаления (без перезапуска)

`restart <name>`

Перезапуск процесса. Примечание: при перезапуске файлы конфигурации не перечитываются. Для этого см. **reread** и **update**.

`restart <gname>:*`

Перезапустить все процессы в группе. Примечание: перезапуск не перечитывает файлы конфигурации. Для этого см. **reread** и **update**.

`restart <name> <name>`

Перезапускает несколько процессов или групп. Примечание: при перезапуске файлы конфигурации не перечитываются. Для этого см. **reread** и **update**.

`restart all`

Перезапускает все процессы. Примечание: перезапуск не перечитывает файлы конфигурации. Для этого см. **reread** и **update**.

`signal`

Нет справки по сигналу

`start <name>`

Начать процесс

`start <gname>:*`

Запустить все процессы в группе

`start <name> <name>`

Запустить несколько процессов или групп

`start all`

Запустить все процессы

`status`

Получить всю информацию о состоянии процесса.

`status <name>`

Получить статус одного процесса по имени.

`status <name> <name>`

Получить статус нескольких именованных процессов.

`stop <name>`

Остановить процесс

`stop <gname>:*`

Остановить все процессы в группе

`stop <name> <name>`

Остановить несколько процессов или групп

`stop all`

Остановить все процессы

`tail [-f] <name> [stdout|stderr]`

По умолчанию - **stdout**. Вывод последней части журналов процесса Пример: `tail -f <name>` Непрерывный вывод именованного процесса **stdout** `Ctrl-C` для выхода. `tail -100 <name>` последние 100 байт процесса stdout `tail <name> stderr` последние `1600` байт процесса **stderr.**

## Сигналы

Программе **supervisord** могут быть отправлены сигналы, которые заставляют ее выполнять определенные действия во время ее работы.

Вы можете отправить любой из этих сигналов одному идентификатору процесса **supervisord**. Этот идентификатор процесса можно найти в файле, представленном параметром **pidfile** в разделе `[supervisord]` файла конфигурации (по умолчанию это `$CWD/supervisord.pid`).

### Обработчики сигналов

**SIGTERM**

**supervisord** и все его подпроцессы будут закрыты. Это может занять несколько секунд.

**SIGINT**

**supervisord** и все его подпроцессы будут закрыты. Это может занять несколько секунд.

**SIGQUIT**

**supervisord** и все его подпроцессы будут закрыты. Это может занять несколько секунд.

**SIGHUP**

**supervisord** остановит все процессы, перезагрузит конфигурацию из первого найденного файла конфигурации и запустит все процессы.

**SIGUSR2**

**supervisord** закроет и снова откроет основной журнал активности и все дочерние файлы журнала.

## Безопасность во время выполнения

Разработчики сделали все возможное, чтобы гарантировать, что использование процесса **supervisord**, работающего от имени пользователя **root**, не приведет к непреднамеренному повышению привилегий. **Но будьте бдительны**. Supervisor не такой параноик, как [daemontools](http://supervisord.org/glossary.html#term-daemontools) DJ Bernstein, поскольку **supervisord** допускает произвольные указания пути в своем файле конфигурации, в который могут быть записаны данные. Разрешение произвольного выбора пути может создать уязвимости от атак по символическим ссылкам. Будьте осторожны при указании путей в вашей конфигурации. Убедитесь, что файл конфигурации **supervisord** не может быть прочитан или записан непривилегированными пользователями, и что все файлы, установленные пакетом **supervisor**, имеют «нормальные» настройки защиты прав доступа к файлам. Кроме того, убедитесь, что ваш **PYTHONPATH** в порядке и что все файлы стандартной библиотеки Python имеют адекватную защиту прав доступа к файлам.

## Запуск supervisord автоматически при запуске

Если вы используете версию **supervisor** из дистрибутива, она уже должна быть интегрирована в инфраструктуру управления службами вашего дистрибутива.

Пользовательские сценарии для различных операционных систем доступны по адресу: [https://github.com/Supervisor/initscripts](https://github.com/Supervisor/initscripts).

В **Serverfault** есть несколько ответов на случай, если вы застряли: [Как автоматически запускать супервизор в Linux (Ubuntu)](http://serverfault.com/questions/96499/how-to-automatically-start-supervisord-on-linux-ubuntu)
