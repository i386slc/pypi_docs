# Указание версии вашего проекта

## Указание версии вашего проекта

**Setuptools** может хорошо работать с большинством схем управления версиями. На протяжении многих лет **setuptools** старался точно следовать схеме [PEP 440](https://peps.python.org/pep-0440/), но также поддерживает устаревшие версии. Однако есть несколько особенностей, на которые следует обращать внимание, чтобы убедиться, что **setuptools** и другие инструменты всегда могут сказать, какая версия вашего пакета новее, чем другая версия. Знание этих вещей также поможет вам правильно указать, от каких версий других проектов зависит ваш проект.

Версия состоит из чередующихся серий номеров выпусков и тегов [pre-release](https://peps.python.org/pep-0440/#pre-releases) или [post-release](https://peps.python.org/pep-0440/#post-releases). Номер версии представляет собой серию цифр, разделенных точками, например `2.4` или `0.5`. Каждая серия цифр обрабатывается численно, поэтому выпуски `2.1` и `2.1.0` — это разные способы написания одного и того же номера выпуска, обозначающие первый подвыпуск выпуска `2`. Но `2.10` — это десятый подвыпуск выпуска `2`, и поэтому он отличается и новее выпуска `2.1` или `2.1.0`. Начальные нули в ряду цифр также игнорируются, поэтому `2.01` совпадает с `2.1` и отличается от `2.0.1`.

После номера выпуска вы можете указать тег _pre-release_ или _post-release_. Предварительные теги делают версию более _**старой**_, чем версия, к которой они добавлены. Таким образом, ревизия `2.4` _**новее**_ версии-кандидата `2.4rc1`, которая, в свою очередь, новее бета-версии `2.4b1` или альфа-версии `2.4a1`. Пострелизные теги позволяют считать версию более _**новой**_, чем версия, к которой они добавлены. Таким образом, такие ревизии, как `2.4.post1`, _**новее**_, чем `2.4`, но _**старше**_, чем `2.4.1` (которая имеет более высокий номер выпуска).

В случае устаревших legacy версий (например, `2.4pl1`) они считаются более старыми, чем неустаревшие версии. Принимая это во внимание, ревизия `2.4pl1` старше, чем `2.4`. Обратите внимание, что `2.4pl1` не соответствует стандарту [PEP 440](https://peps.python.org/pep-0440/).

Предрелизный тег — это последовательность букв, которые в алфавитном порядке предшествуют `«final»`. Некоторые примеры предварительных тегов включают **alpha**, **beta**, **а**, **с**, **dev** и так далее. Вам не нужно ставить точку или тире перед предварительным тегом, если он стоит сразу после числа, но при желании это можно сделать. Таким образом, `2.4c1`, `2.4.c1` и `2.4-c1` представляют кандидата на выпуск **1** версии `2.4`, и **setuptools** считает их идентичными. Обратите внимание, что только теги **a**, **b** и **rc** являются предварительными тегами, совместимыми с [PEP 440](https://peps.python.org/pep-0440/).

Кроме того, есть три специальных предварительных тега, которые обрабатываются так же, как если бы они были **rc**: **c**, **pre** и **preview**. Таким образом, версии `2.4c1`, `2.4pre1` и `2.4preview1` полностью совпадают с версией `2.4rc1` и обрабатываются **setuptools** как идентичные.

Тег post-release — это строка `.post`, за которой следует неотрицательное целое число. Теги post-release обычно используются для отделения номеров исправлений, номеров портов, номеров сборок, номеров редакций или меток даты от номера выпуска. Например, версия `2.4.post1263` может обозначать версию Subversion 1263 исправления после выпуска версии `2.4`. Или вы можете использовать `2.4.post20051127` для обозначения пост-релиза с отметкой даты. Устаревшие теги после выпуска могут быть либо серией букв, которые в алфавитном порядке больше или равны `«final»`, либо тире (`-`) — например, `2.4-r1263` или `2.4-20051127`.

Обратите внимание, что после каждого устаревшего тега до или после выпуска вы можете поместить другой номер выпуска, за которым снова следуют дополнительные теги до или после выпуска. Например, `0.6a9.dev41475` может обозначать версию Subversion 41475 разрабатываемой версии девятой альфа-версии 0.6. Обратите внимание, что **dev** — это предрелизный тег, поэтому эта версия имеет меньший номер версии, чем `0.6a9`, которая фактически является девятой альфа-версией релиза `0.6`. Но `41475` — это тег post-release, поэтому эта версия новее, чем `0.6a9.dev`.

По большей части интерпретация номеров версий в **setuptools** интуитивно понятна, но вот несколько советов, которые помогут вам избежать неприятностей в крайних случаях:

* Не склеивайте смежные предварительные теги вместе без точки или цифры между ними. Версия `1.9adev` является предварительным выпуском версии `1.9` для разработчиков, а не предварительным выпуском версии `1.9a` для разработки. Вместо этого используйте `.dev`, как в `1.9a.dev`, или разделяйте предварительные теги числом, как в `1.9a0dev`. `1.9a.dev`, `1.9a0dev` и даже `1.9a0.dev0` — это идентичные версии с точки зрения **setuptools**, поэтому вы можете использовать любую схему, которую предпочитаете. Из этих примеров только `1.9a0.dev0` совместим с [PEP 440](https://peps.python.org/pep-0440/).
* Если вы хотите быть уверены, что выбранная вами схема нумерации работает именно так, как вы думаете, вы можете использовать функцию `pkg_resources.parse_version()` для сравнения разных номеров версий:

```python
>>> from pkg_resources import parse_version
>>> parse_version("1.9.a.dev") == parse_version("1.9a0dev")
True
>>> parse_version("2.1-rc2") < parse_version("2.1")
True
>>> parse_version("0.6a9dev-r41475") < parse_version("0.6a9")
True
```

После того, как вы определились со схемой нумерации версий для своего проекта, вы можете настроить инструменты настройки, чтобы они автоматически помечали разрабатываемые выпуски различными тегами pre- или post-release. Дополнительные сведения см. в следующем разделе.

## Теггирование и выпуски «Daily Build» или «Snapshot»

{% hint style="warning" %}
Обратите внимание, что запуск `python setup.py ...` напрямую больше не считается хорошей практикой и что в будущем команды **egg\_info** и **rotate** будут объявлены устаревшими.

В результате инструкции и информацию, представленные в этом разделе, следует рассматривать как **переходные**, а инструменты настройки не предоставляют механизма для пометки выпусков.

Между тем, если вы также можете рассмотреть такую возможность, используйте [setuptools-scm](https://pypi.org/project/setuptools-scm) для достижения аналогичных целей.
{% endhint %}

Когда набор связанных проектов находится в стадии разработки, может быть важно отслеживать более подробные приращения версий, чем вы обычно используете, например, для релизов `"stable"`. В то время как стабильные выпуски могут измеряться числами, разделенными точками, с **alpha**/**beta**/и т.д. кодами состояния, разрабатываемые версии проекта часто необходимо отслеживать по номеру редакции или сборки или даже по дате сборки. Это особенно верно, когда разрабатываемые проекты должны ссылаться друг на друга и, следовательно, могут буквально нуждаться в самой последней версии чего-либо!

Для поддержки этих сценариев **setuptools** позволяет вам помечать тегом `"tag"` исходный код и дистрибутивы **egg**, добавляя одно или несколько из следующих значений к «официальному» идентификатору версии проекта:

* Тег предварительной версии, указанный вручную, например, `"build"` или `"dev"`, или тег пострелизной версии, указанный вручную, например номер сборки или версии (`--tag-build=STRING`, `-bSTRING`)
* 8-символьное представление даты сборки (`--tag-date`, `-d`) в виде пострелизного тега.

Вы можете добавить эти теги, добавив **egg\_info** и нужные параметры в командную строку перед командами **sdist** или **bdist**, для которых вы хотите создать ежедневную сборку или snapshot. См. раздел ниже о команде <mark style="color:purple;">egg\_info</mark> для более подробной информации.

(Кроме того, прежде чем выпустить свой проект, обязательно ознакомьтесь с разделом «[Указание версии вашего проекта](ukazanie-versii-vashego-proekta.md#ukazanie-versii-vashego-proekta)» для получения дополнительной информации о том, как теги pre- и post-release влияют на интерпретацию номеров версий. Это важно, чтобы убедиться, что обработка зависимостей инструменты будут знать, какие версии вашего проекта новее других).

Наконец, если вы часто создаете сборки и либо создаете их в загружаемом месте, либо копируете их на сервер распространения, вам, вероятно, следует проверить команду <mark style="color:purple;">rotate</mark>, которая позволяет автоматически удалять все, кроме N самых последних изменений дистрибуции, соответствующие шаблону glob. Итак, вы можете использовать командную строку, например:

```bash
setup.py egg_info -rbDEV bdist_egg rotate -m.egg -k3
```

для сборки **egg**, информация о версии которого включает `"DEV-rNNNN"` (где NNNN — это самая последняя ревизия Subversion, повлиявшая на исходное дерево), а затем удалить все файлы **egg** из каталога дистрибутива, кроме трех, которые были собраны последними.

Если вам нужно управлять автоматическими сборками для нескольких пакетов, каждый из которых имеет свою политику тегирования и ротации, вы также можете проверить команду <mark style="color:purple;">alias</mark>, которая позволит каждому пакету определить псевдоним, например **daily**, который будет выполнять необходимые теги, команды build и rotate. Затем более простой сценарий или задание **cron** могут просто ежедневно запускать `setup.py daily` в каждом каталоге проекта. (Кроме того, вы также можете определить версии псевдонима **daily** по умолчанию для всего сайта или для каждого пользователя, чтобы проекты, которые не определили свои собственные, использовали соответствующие значения по умолчанию.)

## Создание официальных "official" (не "snapshot") выпусков

Когда вы делаете официальный релиз, создавая исходные или бинарные дистрибутивы, вам нужно будет переопределить настройки тега из `setup.cfg`, чтобы в итоге не зарегистрировать версии типа `foobar-0.7a1.dev-r34832`. Это легко сделать, если вы разрабатываете магистраль и используете теги или ветки для своих выпусков — просто внесите изменения в `setup.cfg` после ветвления или тегирования выпуска, чтобы магистраль по-прежнему создавала моментальные снимки разработки.

В качестве альтернативы, если вы не выполняете ветвление для выпусков, вы можете переопределить параметры версии по умолчанию в командной строке, используя что-то вроде:

```bash
setup.py egg_info -Db "" sdist bdist_egg
```

Первая часть этой команды (`egg_info -Db ""`) переопределяет сконфигурированную информацию тега перед созданием sorce и binary egg. Таким образом, эти команды будут использовать обычную версию из вашего `setup.py` без добавления строки обозначения сборки.

Конечно, если вы будете делать это часто, вы можете захотеть создать личный псевдоним для этой операции, например:

```bash
setup.py alias -u release egg_info -Db ""
```

Затем вы можете использовать его следующим образом:

```bash
setup.py release sdist bdist_egg
```

Или, конечно, вы можете создать более сложные псевдонимы, которые делают все вышеперечисленное. Дополнительные идеи см. в разделах ниже, посвященных командам <mark style="color:purple;">egg\_info</mark> и <mark style="color:purple;">alias</mark>.
