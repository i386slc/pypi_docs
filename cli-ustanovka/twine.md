# twine

**Twine** — это утилита для [публикации](https://packaging.python.org/tutorials/packaging-projects/) пакетов Python в [PyPI](https://pypi.org/) и других [репозиториях](https://packaging.python.org/glossary/#term-Package-Index). Он обеспечивает независимую от системы сборки загрузку исходных и [двоичных артефактов](https://packaging.python.org/glossary/#term-Distribution-Package) распространения как для новых, так и для существующих [проектов](https://packaging.python.org/glossary/#term-Project).

## Почему я должен использовать это?

Цель **Twine** — улучшить взаимодействие с PyPI за счет повышения безопасности и тестируемости.

Основная причина использования **Twine** заключается в том, что он надежно аутентифицирует вас в PyPI через HTTPS, используя проверенное соединение, независимо от базовой версии Python. Между тем, `python setup.py upload` будет работать правильно и безопасно только в том случае, если ваша система сборки, версия Python и базовая операционная система настроены правильно.

Во-вторых, **Twine** предлагает вам создавать файлы дистрибутива. `python setup.py upload` позволяет загружать пакет только в качестве последнего шага после сборки с помощью **distutils** или **setuptools** в рамках одного и того же вызова команды. Это означает, что вы не можете протестировать точный файл, который вы собираетесь загрузить в PyPI, чтобы убедиться, что он работает, прежде чем загружать его.

Наконец, **Twine** позволяет вам предварительно подписывать ваши файлы и передавать файлы `.asc` в вызов командной строки (`twine upload myproject-1.0.1.tar.gz myproject-1.0.1.tar.gz.asc`). Это позволяет вам быть уверенным, что вы вводите парольную фразу **gpg** в саму **gpg**, а не где-то еще, поскольку вы будете тем, кто непосредственно выполняет `gpg --detach-sign -a <filename>`.

## Функции

* Проверенные HTTPS-соединения
* Загрузка не требует выполнения `setup.py`
* Загрузка уже созданных файлов, что позволяет тестировать дистрибутивы перед выпуском
* Поддерживает загрузку любого формата упаковки (включая [wheel](https://packaging.python.org/glossary/#term-Wheel))

## Установка

```bash
pip install twine
```

## Использование twine

1. Создайте несколько дистрибутивов обычным способом:

```bash
python -m build
```

2. Загрузите в [Test PyPI](https://packaging.python.org/guides/using-testpypi/) и убедитесь, что все выглядит правильно:

```bash
twine upload -r testpypi dist/*
```

**Twine** запросит ваше имя пользователя и пароль.

3. Загрузите в [PyPI](https://pypi.org/):

```bash
twine upload dist/*
```

4. Готово!

{% hint style="info" %}
Как и многие другие инструменты командной строки, **Twine** не показывает никаких символов при вводе пароля.

Если вы используете Windows и пытаетесь вставить свое имя пользователя, пароль или токен в командную строку или PowerShell, **Ctrl-V** и **Shift+Insert** _не сработают_. Вместо этого вы можете использовать `"Edit > Paste"` в меню окна или включить `"Use Ctrl+Shift+C/V as Copy/Paste"` в `"Properties"`. Это [известная проблема](https://bugs.python.org/issue37426) с модулем Python **getpass**.
{% endhint %}

Дополнительная документация по использованию Twine для загрузки пакетов в PyPI находится в [Руководстве пользователя по упаковке Python](https://packaging.python.org/tutorials/packaging-projects/).

## Команды

### twine upload

Загружает один или несколько дистрибутивов в репозиторий.

```
испол: twine upload [-h] [-r REPOSITORY] [--repository-url REPOSITORY_URL]
                    [-s] [--sign-with SIGN_WITH] [-i IDENTITY] [-u USERNAME]
                    [-p PASSWORD] [--non-interactive] [-c COMMENT]
                    [--config-file CONFIG_FILE] [--skip-existing]
                    [--cert path] [--client-cert path] [--verbose]
                    [--disable-progress-bar]
                    dist [dist ...]

позиционные аргументы:
  dist                  Файлы дистрибутива для загрузки в репозиторий (индекс пакетов).
                        Обычно dist/* . Может дополнительно содержать файл .asc
                        для включения существующей подписи при загрузке файла.

опциональные настройки:
  -h, --help            показать это справочное сообщение и выйти
  -r REPOSITORY, --repository REPOSITORY
                        Репозиторий (индекс пакета) для загрузки пакета.
                        Должен быть раздел в файле конфигурации (по умолчанию: pypi).
                        (Также можно установить через переменную окружения
                        TWINE_REPOSITORY.)
  --repository-url REPOSITORY_URL
                        URL репозитория (индекса пакета) для загрузки пакета.
                        Это переопределяет --repository. (Также можно установить
                        через переменную окружения TWINE_REPOSITORY_URL.)
  -s, --sign            Подписывает файлы для загрузки с помощью GPG.
  --sign-with SIGN_WITH
                        Программа GPG, используемая для подписи загрузок
                        (по умолчанию: gpg).
  -i IDENTITY, --identity IDENTITY
                        Идентификатор GPG, используемый для подписи файлов.
  -u USERNAME, --username USERNAME
                        Имя пользователя для аутентификации в репозитории
                        (индекс пакета). (Также можно установить с помощью переменной
                        среды TWINE_USERNAME.)
  -p PASSWORD, --password PASSWORD
                        Пароль для аутентификации в репозитории (индекс пакета).
                        (Также можно установить с помощью переменной среды
                        TWINE_PASSWORD.)
  --non-interactive     Не запрашивает в интерактивном режиме имя пользователя/пароль,
                        если необходимые учетные данные отсутствуют.
                        (Также можно установить с помощью переменной среды
                        TWINE_NON_INTERACTIVE.)
  -c COMMENT, --comment COMMENT
                        Комментарий для включения в файл дистрибутива.
  --config-file CONFIG_FILE
                        Используемый файл конфигурации .pypirc.
  --skip-existing       Продолжает загружать файлы, если они уже существуют.
                        (Действительно только при загрузке в PyPI. Другие реализации
                        могут не поддерживать это.)
  --cert path           Путь к альтернативному комплекту CA (также можно задать
                        через переменную среды TWINE_CERT).
  --client-cert path    Путь к сертификату клиента SSL, один файл, содержащий
                        закрытый ключ и сертификат в формате PEM.
  --verbose             Показать подробный вывод.
  --disable-progress-bar
                        Отключить индикатор выполнения.
```

### twine check

Проверяет, правильно ли длинное описание вашего дистрибутива будет отображаться в PyPI.

```
использование: twine check [-h] [--strict] dist [dist ...]

позиционные аргументы:
  dist        Файлы дистрибутива для проверки, обычно dist/*

опциональные настройки:
  -h, --help  показать это справочное сообщение и выйти
  --strict    Сбой при предупреждениях
```

### twine register

Предварительно регистрирует имя в репозитории перед загрузкой дистрибутива.

{% hint style="warning" %}
Предварительная регистрация [не поддерживается в PyPI](https://packaging.python.org/guides/migrating-to-pypi-org/#registering-package-names-metadata), поэтому команда **register** необходима только в том случае, если вы используете другой репозиторий, для которого она требуется. Дополнительные сведения см. в [issue #1627 в Warehouse](https://github.com/pypa/warehouse/issues/1627) (программное обеспечение, работающее на PyPI).
{% endhint %}

```
испол: twine register [-h] [-r REPOSITORY] [--repository-url REPOSITORY_URL]
                      [-s] [--sign-with SIGN_WITH] [-i IDENTITY] [-u USERNAME]
                      [-p PASSWORD] [--non-interactive] [-c COMMENT]
                      [--config-file CONFIG_FILE] [--skip-existing]
                      [--cert path] [--client-cert path] [--verbose]
                      [--disable-progress-bar]
                      package

операция регистрации не требуется с PyPI.org

позиционные аргументы:
  package               File from which we read the package metadata.

опциональные настройки:
  -h, --help            показать это справочное сообщение и выйти
  -r REPOSITORY, --repository REPOSITORY
                        Репозиторий (индекс пакета) для загрузки пакета.
                        Должен быть раздел в файле конфигурации (по умолчанию: pypi).
                        (Также можно установить через переменную окружения
                        TWINE_REPOSITORY.)
  --repository-url REPOSITORY_URL
                        URL репозитория (индекса пакета) для загрузки пакета.
                        Это переопределяет --repository. (Также можно установить
                        через переменную окружения TWINE_REPOSITORY_URL.)
  -s, --sign            Подписывает файлы для загрузки с помощью GPG.
  --sign-with SIGN_WITH
                        Программа GPG, используемая для подписи загрузок
                        (по умолчанию: gpg).
  -i IDENTITY, --identity IDENTITY
                         Идентификатор GPG, используемый для подписи файлов.
  -u USERNAME, --username USERNAME
                         Имя пользователя для аутентификации в репозитории
                        (индекс пакета). (Также можно установить с помощью переменной
                        среды TWINE_USERNAME.)
  -p PASSWORD, --password PASSWORD
                         Пароль для аутентификации в репозитории (индекс пакета).
                        (Также можно установить с помощью переменной среды
                        TWINE_PASSWORD.)
  --non-interactive      Не запрашивает в интерактивном режиме имя пользователя/пароль,
                        если необходимые учетные данные отсутствуют.
                        (Также можно установить с помощью переменной среды
                        TWINE_NON_INTERACTIVE.)
  -c COMMENT, --comment COMMENT
                        Комментарий для включения в файл дистрибутива.
  --config-file CONFIG_FILE
                        Используемый файл конфигурации .pypirc.
  --skip-existing        Продолжает загружать файлы, если они уже существуют.
                        (Действительно только при загрузке в PyPI. Другие реализации
                        могут не поддерживать это.)
  --cert path           Путь к альтернативному комплекту CA (также можно задать
                        через переменную среды TWINE_CERT).
  --client-cert path    Путь к сертификату клиента SSL, один файл, содержащий
                        закрытый ключ и сертификат в формате PEM.
  --verbose             Показать подробный вывод.
  --disable-progress-bar
                        Отключить индикатор выполнения.
```

## Конфигурация

**Twine** может считывать конфигурацию репозитория из файла `.pypirc`, находящегося либо в вашем домашнем каталоге, либо в параметре `--config-file`. Подробнее о написании и использовании `.pypirc` см. в [спецификации](https://packaging.python.org/specifications/pypirc/) в Руководстве пользователя по упаковке Python.&#x20;

### Переменные среды

Twine также поддерживает настройку через переменные среды. Параметры, переданные в командной строке, будут иметь приоритет над параметрами, заданными через переменные среды. Определение через переменную среды полезно в средах, где неудобно создавать файл `.pypirc` (например, на сервере CI/build).

* **TWINE\_USERNAME** — имя пользователя для аутентификации в репозитории.
* **TWINE\_PASSWORD** — пароль для аутентификации в хранилище.
* **TWINE\_REPOSITORY** — конфигурация репозитория, определенная как раздел в `.pypirc` или указанная как полный URL-адрес.
* **TWINE\_REPOSITORY\_URL** — URL репозитория для использования.
* **TWINE\_CERT** — пользовательский сертификат CA для использования в репозиториях с самозаверяющими или ненадежными сертификатами.
* **TWINE\_NON\_INTERACTIVE** — не запрашивать интерактивно имя пользователя/пароль, если необходимые учетные данные отсутствуют.

### Поддержка прокси

**Twine** можно настроить на использование прокси, установив переменные среды. Например, чтобы использовать прокси только для команды **twine**, не экспортируя **export** его для других инструментов:

```bash
HTTPS_PROXY=socks5://user:pass@host:port twine upload dist/*
```

Дополнительные сведения см. в документации Requests по [прокси](https://requests.readthedocs.io/en/latest/user/advanced/#proxies) и [SOCKS](https://requests.readthedocs.io/en/latest/user/advanced/#socks), а также в [подробной статье о переменных среды прокси](https://about.gitlab.com/blog/2021/01/27/we-need-to-talk-no-proxy/).

## Поддержка keyring

Вместо того, чтобы вводить пароль каждый раз, когда вы загружаете дистрибутив, **Twine** позволяет безопасно хранить имя пользователя и пароль с помощью набора ключей [keyring](https://pypi.org/project/keyring/). **Keyring** устанавливается вместе с **Twine**, но для некоторых систем (в основном Linux) могут потребоваться [дополнительные действия по установке](https://pypi.org/project/keyring/#installation-linux).

После установки **Twine** используйте программу для набора ключей **keyring**, чтобы установить имя пользователя и пароль для каждого репозитория, в который вы можете загружать файлы.

Например, чтобы установить имя пользователя и пароль для PyPI:

```bash
keyring set https://upload.pypi.org/legacy/ your-username
```

и введите пароль при появлении запроса.

Для другого репозитория замените URL-адрес соответствующим URL-адресом репозитория. Например, для тестирования PyPI используйте `https://test.pypi.org/legacy/`.

В следующий раз, когда вы запустите **twine**, он запросит у вас имя пользователя, а затем получит соответствующий пароль от **Keyring**.

{% hint style="info" %}
Если вы используете Linux в среде без HEAD (например, на сервере), вам необходимо выполнить некоторые дополнительные действия, чтобы убедиться, что **Keyring** может безопасно хранить секреты. См. [Использование Keyring в безголовых системах](https://keyring.readthedocs.io/en/latest/#using-keyring-on-headless-linux-systems).
{% endhint %}

### Отключение Keyring

В большинстве случаев простое отсутствие установки пароля с помощью набора ключей **keyring** позволяет **Twine** вернуться к запросу пароля. В некоторых случаях наличие **Keyring** вызовет неожиданные или нежелательные подсказки от резервной системы. В этих случаях может быть желательно полностью отключить **Keyring**. Чтобы отключить его, запустите:

```bash
keyring --disable
```

См. [twine issue #338](https://github.com/pypa/twine/issues/338) для обсуждения и предыстории.
